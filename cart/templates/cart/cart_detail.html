{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mx-auto px-6 py-8">
  <h2 class="text-2xl font-bold mb-6">Your Cart</h2>

  <!-- Toasts / messages -->
  <div id="toast-container" class="fixed top-6 right-6 z-50 space-y-2"></div>

  <div class="bg-white rounded-lg shadow overflow-hidden">
    <table class="min-w-full" id="cart-table">
      <thead class="bg-gray-100">
        <tr>
          <th class="py-3 px-4 text-left">Product</th>
          <th class="py-3 px-4 text-left">Price</th>
          <th class="py-3 px-4 text-left">Quantity</th>
          <th class="py-3 px-4 text-left">Total</th>
          <th class="py-3 px-4 text-right">Actions</th>
        </tr>
      </thead>
      <tbody id="cart-body">
        {% for item in cart %}
        <tr class="border-b align-middle" 
            data-price="{{ item.price }}" 
            data-max-stock="{{ item.product.stock }}" 
            data-product-id="{{ item.product.id }}">
          <td class="py-3 px-4 flex items-center space-x-3">
            {% if item.product.image %}
            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="w-14 h-14 object-cover rounded">
            {% else %}
            <div class="w-14 h-14 bg-gray-200 rounded flex items-center justify-center text-gray-500">No Image</div>
            {% endif %}
            <div>
              <div class="font-semibold text-gray-800">{{ item.product.name }}</div>
              <div class="text-xs text-gray-500">SKU: {{ item.product.id }}</div>
            </div>
          </td>

          <td class="py-3 px-4 text-gray-700">Rs <span class="cell-price">{{ item.price }}</span></td>

          <td class="py-3 px-4">
            <div class="inline-flex items-center border rounded overflow-hidden select-none">
              <button class="decrement px-3 py-1 text-gray-600 hover:bg-gray-100" aria-label="decrease">âˆ’</button>
              <div class="px-4 py-1 text-center quantity-display" aria-live="polite">{{ item.quantity }}</div>
              <button class="increment px-3 py-1 text-gray-600 hover:bg-gray-100" aria-label="increase">+</button>
            </div>
            <div class="text-xs text-gray-500 mt-1">Available: <span class="stock-available">{{ item.product.stock }}</span></div>
          </td>

          <td class="py-3 px-4 text-gray-800">Rs <span class="text-total">{{ item.total_price }}</span></td>

          <td class="py-3 px-4 text-right">
            <button class="remove-btn px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600" type="button"
                    data-remove-url="{% url 'cart:cart_remove' item.product.id %}">
              Remove
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-center py-8 text-gray-500">
            <div class="mb-4">
              <img src="{% static 'images/empty-cart.svg' %}" alt="Empty" class="mx-auto w-40 opacity-80">
            </div>
            <div class="text-lg mb-2">Your cart is empty</div>
            <a href="{% url 'ecommerce:product_list' %}" class="inline-block px-5 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Start Shopping</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Summary -->
  <div class="flex justify-between items-center mt-6">
    <div class="text-gray-600">
      <div class="text-sm">Subtotal</div>
      <div class="text-2xl font-bold text-gray-900">Rs <span id="cart-total">{{ cart.get_total_price }}</span></div>
    </div>

    <div class="flex items-center gap-3">
      <a id="continue-shopping" href="{% url 'ecommerce:product_list' %}" class="px-4 py-2 bg-white border rounded hover:bg-gray-50">Continue shopping</a>
      <a id="checkout-btn" href="" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Checkout</a>
    </div>
  </div>
</div>

<!-- Styles: small helper styles (Tailwind used for main layout) -->
<style>
  /* toast animation */
  .toast-enter { transform: translateY(-10px); opacity: 0; }
  .toast-show { transform: translateY(0); opacity: 1; transition: all .28s ease; }
</style>

<!-- JavaScript: AJAX + optimistic updates + CSRF helper -->
<script>
(function () {
  // Helpers
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  function toast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const el = document.createElement('div');
    el.className = 'px-4 py-2 rounded shadow-md text-white';
    el.style.zIndex = 9999;
    if (type === 'error') el.style.background = '#ef4444';
    else if (type === 'success') el.style.background = '#10b981';
    else el.style.background = '#374151';
    el.textContent = message;
    el.classList.add('toast-enter');
    container.appendChild(el);
    requestAnimationFrame(() => el.classList.add('toast-show'));
    setTimeout(() => { el.remove(); }, 3000);
  }

  function formatNumber(n) { return Number(n).toFixed(2); }

  function updateCartTotal() {
    let total = 0;
    document.querySelectorAll('#cart-body tr[data-price]').forEach(row => {
      const totalCell = row.querySelector('.text-total');
      const value = parseFloat(totalCell.textContent) || 0;
      total += value;
    });
    const totalEl = document.getElementById('cart-total');
    if (totalEl) totalEl.textContent = formatNumber(total);
  }

  // Send add/update via fetch
  async function postUpdate(url, bodyObj) {
    const body = new URLSearchParams();
    Object.keys(bodyObj).forEach(k => body.append(k, bodyObj[k]));
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: body.toString()
    });
    if (!res.ok) throw new Error('Network response not ok');
    return res.json().catch(() => ({}));
  }

  // Bind controls
  document.addEventListener('DOMContentLoaded', () => {
    const rows = Array.from(document.querySelectorAll('#cart-body tr[data-price]'));
    if (rows.length === 0) {
      updateCartTotal();
      return;
    }

    rows.forEach(row => {
      const price = parseFloat(row.dataset.price);
      const maxStock = parseInt(row.dataset.maxStock, 10) || 0;
      const productId = row.dataset.productId;
      const qtyEl = row.querySelector('.quantity-display');
      const totalEl = row.querySelector('.text-total');
      const increment = row.querySelector('.increment');
      const decrement = row.querySelector('.decrement');
      const removeBtn = row.querySelector('.remove-btn');

      function setQty(q) {
        qtyEl.textContent = q;
        totalEl.textContent = formatNumber(q * price);
        updateCartTotal();
      }

      // Debounced save to reduce requests
      let debounceTimer = null;
      function saveQtyToServer(q) {
        if (debounceTimer) clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
          try {
            const url = "{% url 'cart:cart_add' 0 %}".replace('0', productId);
            await postUpdate(url, { quantity: q, override: 'True' });
            toast('Cart updated', 'success');
          } catch (err) {
            toast('Error updating cart', 'error');
          }
        }, 250);
      }

      // Increment
      increment && increment.addEventListener('click', () => {
        let q = parseInt(qtyEl.textContent, 10);
        if (q < maxStock) {
          q += 1;
          setQty(q);
          saveQtyToServer(q);
        } else {
          toast(`Only ${maxStock} left in stock`, 'error');
        }
      });

      // Decrement
      decrement && decrement.addEventListener('click', () => {
        let q = parseInt(qtyEl.textContent, 10);
        if (q > 1) {
          q -= 1;
          setQty(q);
          saveQtyToServer(q);
        }
      });

      // Remove (optimistic)
      removeBtn && removeBtn.addEventListener('click', async (e) => {
        const removeUrl = e.currentTarget.dataset.removeUrl;
        // visually remove row first
        row.remove();
        updateCartTotal();
        try {
          // call backend to remove
          await fetch(removeUrl, { method: 'POST', headers: { 'X-CSRFToken': csrftoken }});
          toast('Item removed', 'success');
        } catch (err) {
          toast('Error removing item', 'error');
        }

        // show go to shopping if empty
        if (!document.querySelector('#cart-body tr[data-price]')) {
          document.getElementById('checkout-btn').classList.add('hidden');
          // optionally show the start shopping block (or redirect)
        }
      });
    });

    // initial totals fix
    updateCartTotal();
  });
})();
</script>
{% endblock %}
